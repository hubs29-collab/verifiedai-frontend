<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VerifiedAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
    }
    header {
      background: #0b2a4a;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .card {
      background: white;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 8px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }
    button:disabled {
      background: #9ca3af;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
    }
    .item {
      border: 1px solid #ddd;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
    }
    .verdict {
      font-weight: bold;
      margin-top: 6px;
    }
    pre {
      background: #eef2ff;
      padding: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<header>
  <h1>VerifiedAI</h1>
  <p>Verify scopes, proposals, and costs with confidence</p>
</header>

<div class="card">
  <h3>1. Start Verification</h3>
  <button onclick="startJob()">Start Verification</button>
  <pre id="jobBox"></pre>
</div>

<div class="card">
  <h3>2. Upload Proposal (PDF or Image)</h3>
  <input type="file" id="proposalFile" />
  <button onclick="uploadProposal()">Upload Proposal</button>
  <pre id="proposalBox"></pre>
</div>

<div class="card">
  <h3>3. Add / Review Line Items</h3>
  <input id="desc" placeholder="Paint living room wall" />
  <input id="cost" placeholder="2800" />
  <button onclick="addItem()">Add Line Item</button>
  <div id="itemsBox"></div>
</div>

<div class="card">
  <h3>4. Upload Evidence (Photos)</h3>
  <input type="file" id="files" multiple />
  <button onclick="uploadEvidence()">Upload Evidence</button>
  <pre id="uploadBox"></pre>
</div>

<div class="card">
  <h3>5. Analyze</h3>
  <button onclick="analyze()">Analyze Proposal</button>
</div>

<div class="card">
  <h3>6. Results</h3>
  <button onclick="getResults()">Get Results</button>
  <div id="resultsBox"></div>
</div>

<div class="card">
  <h3>7. Download</h3>
  <button onclick="downloadReport()">Download Verified Report (PDF)</button>
</div>

<script>
const API_BASE =
  "https://ebb700d3-0624-496c-8a99-8d7888669f68-00-2wqp9jjowl32z.picard.replit.dev";

let jobId = null;

async function startJob() {
  const r = await fetch(API_BASE + "/jobs", { method: "POST" });
  const d = await r.json();
  jobId = d.jobId;
  jobBox.textContent = "Job ID: " + jobId;
  itemsBox.innerHTML = "";
  resultsBox.innerHTML = "";
  proposalBox.textContent = "";
}

async function uploadProposal() {
  if (!jobId) return alert("Start verification first");
  if (!proposalFile.files.length) return alert("Select a file");

  const fd = new FormData();
  fd.append("file", proposalFile.files[0]);

  const r = await fetch(`${API_BASE}/proposal/${jobId}`, {
    method: "POST",
    body: fd
  });

  const d = await r.json();
  proposalBox.textContent = JSON.stringify(d, null, 2);

  d.parsedItems?.forEach(item => renderItem(item));
}

async function addItem() {
  if (!jobId) return alert("Start verification first");

  const r = await fetch(`${API_BASE}/items/${jobId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      description: desc.value,
      cost: cost.value
    })
  });

  const item = await r.json();
  renderItem(item);
}

function renderItem(item) {
  const div = document.createElement("div");
  div.className = "item";
  div.innerHTML = `
    <strong>${item.description}</strong><br>
    Claimed Cost: $${item.cost}<br>
    <small>Item ID: ${item.id}</small>
  `;
  itemsBox.appendChild(div);
}

async function uploadEvidence() {
  if (!jobId) return alert("Start verification first");

  const fd = new FormData();
  for (const f of files.files) fd.append("files", f);

  const r = await fetch(`${API_BASE}/evidence/${jobId}`, {
    method: "POST",
    body: fd
  });

  uploadBox.textContent = JSON.stringify(await r.json(), null, 2);
}

async function analyze() {
  if (!jobId) return alert("Start verification first");
  await fetch(`${API_BASE}/analyze/${jobId}`, { method: "POST" });
  alert("Analysis complete");
}

async function getResults() {
  if (!jobId) return alert("Start verification first");

  const r = await fetch(`${API_BASE}/results/${jobId}`);
  const data = await r.json();

  resultsBox.innerHTML = "";

  data.items.forEach(item => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <strong>${item.description}</strong><br>
      Claimed Cost: $${item.cost}<br>
      <div class="verdict">
        Scope: ${item.verdict.status} (${item.verdict.confidence})<br>
        Cost: ${item.costCheck.status}
      </div>
      <p>${item.verdict.explanation}</p>
      <p>${item.costCheck.explanation}</p>
    `;
    resultsBox.appendChild(div);
  });
}

function downloadReport() {
  if (!jobId) return alert("Start verification first");
  window.open(`${API_BASE}/report/${jobId}`, "_blank");
}
</script>

</body>
</html>
